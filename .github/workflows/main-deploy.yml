name: Complete Deploy Pipeline

# Trigger del workflow: push sul branch master  
on:
  push:
    branches: [ master ]

jobs:
  deploy:
    name: Deploy via Webhook
    runs-on: ubuntu-latest  # Torna ai GitHub runners
    environment: Production
    
    steps:
    # 1. Checkout del codice
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 2. Debug della configurazione
    - name: Debug secrets configuration
      run: |
        echo "HOST is set: ${{ secrets.HOST != '' }}"
        echo "USERNAME is set: ${{ secrets.USERNAME != '' }}"
        echo "SSH_PRIVATE_KEY is set: ${{ secrets.SSH_PRIVATE_KEY != '' }}"
      
    # 3. Test connessione SSH
    - name: Test SSH Connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 30s
        script: |
          echo "‚úÖ SSH connection successful!"
          echo "Current user: $(whoami)"
          echo "Current directory: $(pwd)"
          
    # 4. Trigger deploy webhook sul server
    - name: Trigger Deploy Webhook
      run: |
        echo "üöÄ Triggering deploy webhook on server..."
        
        # Invia richiesta al webhook server
        curl -f -X POST "http://90.147.144.144:9000/deploy" \
          -H "Content-Type: application/json" \
          -d '{
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "author": "${{ github.actor }}"
          }' || {
          echo "‚ùå Webhook failed! Server might be down."
          exit 1
        }
        
        echo "‚úÖ Deploy webhook sent successfully!"

    # 5. Notifica del risultato
    - name: Notify deployment result
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Deploy completato con successo!"
        else
          echo "‚ùå Deploy fallito!"
          exit 1
        fi