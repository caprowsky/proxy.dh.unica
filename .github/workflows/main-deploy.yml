name: Deploy Notification

# Trigger del workflow: push sul branch master  
on:
  push:
    branches: [ master ]

jobs:
  notify-deploy:
    name: Deploy and Show Status
    runs-on: ubuntu-latest
    environment: Production
    
    steps:
    # 1. Checkout del codice
    - name: Checkout code
      uses: actions/checkout@v4
          
    # 2. Trigger deploy immediato e mostra risultato
    - name: Deploy and Show Result
      uses: appleboy/ssh-action@v1.0.3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        host: 90.147.144.144
        username: dhwp  
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 120s
        command_timeout: 300s
        script: |
          echo "ğŸš€ Deploy triggered for repository: ${{ github.repository }}"
          echo "ğŸ“… Time: $(date -u)"
          echo "ğŸ”„ Branch: ${{ github.ref_name }}" 
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "ğŸ“Š Commit message: ${{ github.event.head_commit.message }}"
          echo ""
          
          # Esegui deploy immediato
          echo "âš¡ Executing immediate deploy..."
          cd /home/dhwp/proxy.dh.unica
          
          # Forza il fetch per essere sicuri
          git fetch origin
          
          LOCAL_COMMIT=$(git rev-parse HEAD)
          REMOTE_COMMIT=$(git rev-parse origin/master)
          
          echo "ğŸ“ Local commit:  $LOCAL_COMMIT"
          echo "ğŸ“ Remote commit: $REMOTE_COMMIT"
          
          if [ "$LOCAL_COMMIT" != "$REMOTE_COMMIT" ]; then
              echo "ï¿½ New commits found - deploying..."
              
              git reset --hard origin/master
              git pull origin master
              
              echo "ğŸ”„ Executing nginx-reload.sh..."
              chmod +x nginx-reload.sh
              ./nginx-reload.sh
              
              echo "âœ… Verifying nginx configuration..."
              docker exec dhunica_proxypass nginx -t
              
              echo "ğŸ‰ Deploy completed successfully!"
          else
              echo "ğŸ’¡ Already up to date - no deploy needed"
          fi